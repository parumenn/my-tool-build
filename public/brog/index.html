            // Detail view loader
            useEffect(() => {
                const isPost = route.mode === 'post';
                const isEditor = route.mode === 'editor';
                
                if ((isPost || isEditor) && route.id) {
                    // IDがある場合は詳細データを取得（または既存データを確認）
                    if (!selectedPost || selectedPost.id !== route.id) {
                        const loadDetail = async () => {
                            try {
                                const res = await fetch(`${API_URL}?action=detail&id=${route.id}`);
                                if (!res.ok) throw new Error('Not found');
                                const data = await res.json();
                                if (data && !data.error) {
                                    setSelectedPost(data);
                                } else {
                                    if(isPost) navigate('list'); // 閲覧モードならリストへ
                                }
                            } catch(e) { if(isPost) navigate('list'); }
                        };
                        loadDetail();
                    }
                } else if (!isEditor) {
                    // 編集モード以外（かつ詳細モードでない）場合は選択をクリア
                    // 新規作成(mode=editor, id=null)の場合はここでクリアせず、ボタン押下時にクリア済みとする
                    setSelectedPost(null);
                }
            }, [route.mode, route.id]);

            const handleLogin = (t) => { localStorage.setItem('brog_token', t); setToken(t); navigate('admin'); };
            const handleLogout = () => { localStorage.removeItem('brog_token'); setToken(null); navigate('list'); };

            const handleSavePost = async (postData) => {
                await fetch(`${API_URL}?action=save`, { method: 'POST', body: JSON.stringify(postData) });
                await fetchPosts(); navigate('admin');
            };

            const handleDeletePost = async (id) => {
                if(!confirm('本当に削除しますか？')) return;
                await fetch(`${API_URL}?action=delete&id=${id}`, { method: 'DELETE' });
                await fetchPosts();
            };

            const allTags = useMemo(() => {
                const tagSet = new Set();
                posts.forEach(p => {
                    if (Array.isArray(p.tags)) {
                        p.tags.forEach(t => tagSet.add(t));
                    }
                });
                return Array.from(tagSet).sort();
            }, [posts]);

            if (blocked) return <BlockedScreen />;

            // Public list filtering
            const publicPosts = posts.filter(p => (!p.status || p.status === 'published') && !isFuture(p.date));

            return (
                <div className="min-h-screen pb-20 relative">
                    <div className="fixed left-4 top-24 hidden xl:block w-[160px] h-[600px] z-10"><AdBanner type="skyscraper" /></div>
                    <div className="fixed right-4 top-24 hidden xl:block w-[160px] h-[600px] z-10"><AdBanner type="skyscraper" /></div>

                    <Header onNavigate={navigate} isAdmin={!!token} logout={handleLogout} />
                    <main className="max-w-4xl mx-auto px-4 mt-8">
                        {route.mode === 'list' && <PostList posts={publicPosts} onPostClick={(p) => navigate('post', p.id)} />}
                        
                        {route.mode === 'post' && selectedPost && <PostDetail post={selectedPost} onBack={() => navigate('list')} />}
                        
                        {route.mode === 'login' && <Login onLogin={handleLogin} setBlocked={setBlocked} />}
                        
                        {route.mode === 'admin' && token && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">記事管理</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => navigate('password')} className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-50 flex items-center gap-2"><Icon name="key" size={16}/> パスワード変更</button>
                                        <button onClick={() => { setSelectedPost(null); navigate('editor'); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 flex items-center gap-2"><Icon name="plus" size={16}/> 新規作成</button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                                    {posts.map(p => {
                                        const isScheduled = (!p.status || p.status === 'published') && isFuture(p.date);
                                        const isDraft = p.status === 'draft';
                                        return (
                                            <div key={p.id} className="p-4 border-b border-slate-100 last:border-0 flex justify-between items-center hover:bg-slate-50">
                                                <div className={`truncate flex-1 font-bold mr-4 flex items-center gap-2 ${isDraft ? 'text-gray-400' : 'text-slate-700'}`}>
                                                    {isDraft && <span className="text-[10px] bg-gray-200 text-gray-500 px-2 py-0.5 rounded">下書き</span>}
                                                    {isScheduled && <span className="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded flex items-center gap-1"><Icon name="clock" size={10} /> 予約: {p.date}</span>}
                                                    {p.title}
                                                </div>
                                                <div className="flex gap-2 shrink-0">
                                                    <button onClick={() => { setSelectedPost(p); navigate('editor', p.id); }} className="p-2 text-slate-400 hover:text-indigo-600 bg-white border border-slate-200 rounded-lg"><Icon name="edit-2" size={16}/></button>
                                                    <button onClick={() => handleDeletePost(p.id)} className="p-2 text-slate-400 hover:text-red-500 bg-white border border-slate-200 rounded-lg"><Icon name="trash" size={16}/></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {route.mode === 'editor' && token && (
                            <AdminEditor 
                                key={selectedPost ? selectedPost.id : 'new'} 
                                post={selectedPost} 
                                allTags={allTags}
                                onSave={handleSavePost} 
                                onCancel={() => navigate('admin')} 
                            />
                        )}