            const handlePaste = async (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let file = null;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") === 0) { file = items[i].getAsFile(); break; }
                }
                if (file) {
                    e.preventDefault(); 
                    const formData = new FormData(); formData.append('file', file);
                    try {
                        execCmd('insertHTML', '<span id="loading-img">Uploading pasted image...</span>');
                        const res = await fetch(`${API_URL}?action=upload`, { method: 'POST', body: formData });
                        const data = await res.json();
                        const loadingSpan = document.getElementById('loading-img'); if(loadingSpan) loadingSpan.remove();
                        if (res.ok && data.url) {
                            let imgUrl = data.url;
                            if (imgUrl.includes('api.php') && !imgUrl.startsWith('http')) {
                                const origin = window.location.origin;
                                const parts = imgUrl.split('api.php');
                                const query = parts.length > 1 ? parts[1] : '';
                                imgUrl = `${origin}/brog/api.php${query}`;
                            }
                            execCmd('insertImage', imgUrl);
                        }
                        else alert('アップロード失敗: ' + (data.error || 'Unknown error'));
                    } catch (err) {
                        const loadingSpan = document.getElementById('loading-img'); if(loadingSpan) loadingSpan.remove();
                        alert('通信エラーが発生しました');
                    }
                }
            };

            // 画像ダブルクリックでAltテキストを編集
            const handleImageDblClick = (e) => {
                if (e.target.tagName === 'IMG') {
                    const img = e.target;
                    const newAlt = prompt('画像の代替テキスト(alt)を入力:', img.alt);
                    if (newAlt !== null) {
                        img.alt = newAlt;
                    }
                }
            };

            const handleSubmit = (status) => {
                let content = editorRef.current.innerHTML;
                const origin = window.location.origin;
                // 保存時は相対パス(api.php)に戻すことでポータビリティを確保
                content = content.split(`${origin}/brog/api.php`).join('api.php');
                content = content.split(`api.php`).join('api.php'); // 重複回避
                
                onSave({ 
                    ...post, 
                    title, 
                    content, 
                    tags: tags.split(',').map(t=>t.trim()).filter(Boolean), 
                    date: toDbFormat(date), 
                    status: status 
                });
            };

            return (
                <div className="bg-white rounded-2xl p-6 shadow-xl border border-slate-100">
                    <h2 className="text-xl font-bold mb-6 flex items-center gap-2"><Icon name="edit-3" size={20} /> {post ? '記事編集' : '新規投稿'}</h2>
                    <form onSubmit={e => e.preventDefault()} className="space-y-4">
                        <div><label className="block text-xs font-bold text-slate-500 mb-1">タイトル</label><input type="text" value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-3 border rounded-xl" required /></div>
                        <div><label className="block text-xs font-bold text-slate-500 mb-1">公開日時 (未来の日時で予約投稿)</label><input type="datetime-local" value={date} onChange={e=>setDate(e.target.value)} className="w-full p-3 border rounded-xl font-mono text-sm" required /></div>
                        <div>
    <label className="block text-xs font-bold text-slate-500 mb-1">本文</label>
    
    <div className="border rounded-xl bg-white relative">
        <div className="bg-slate-50 border-b p-2 flex gap-1 items-center flex-wrap sticky top-16 z-20 shadow-sm rounded-t-xl">
            <button type="button" onClick={()=>execCmd('formatBlock', 'H1')} className="p-2 hover:bg-slate-200 rounded text-slate-600 font-bold text-sm" title="見出し1">H1</button>
            <button type="button" onClick={()=>execCmd('formatBlock', 'H2')} className="p-2 hover:bg-slate-200 rounded text-slate-600 font-bold text-sm" title="見出し2">H2</button>
            <button type="button" onClick={()=>execCmd('formatBlock', 'H3')} className="p-2 hover:bg-slate-200 rounded text-slate-600 font-bold text-sm" title="見出し3">H3</button>
            <button type="button" onClick={()=>execCmd('formatBlock', 'P')} className="p-2 hover:bg-slate-200 rounded text-slate-600 font-bold text-sm" title="標準テキスト">P</button>
            <div className="w-px h-6 bg-slate-300 mx-1"></div>
            <button type="button" onClick={()=>execCmd('bold')} className="p-2 hover:bg-slate-200 rounded text-slate-600" title="太字"><Icon name="bold" size={16}/></button>
            <button type="button" onClick={()=>{const url=prompt('URL:'); if(url) execCmd('createLink', url)}} className="p-2 hover:bg-slate-200 rounded text-slate-600" title="リンク"><Icon name="link" size={16}/></button>
            <button type="button" onClick={()=>execCmd('formatBlock', 'pre')} className="p-2 hover:bg-slate-200 rounded text-slate-600" title="コードブロック"><Icon name="code" size={16}/></button>
            <div className="w-px h-6 bg-slate-300 mx-1"></div>
            <button type="button" onClick={()=>fileInputRef.current.click()} className="p-2 hover:bg-slate-200 rounded text-slate-600" title="画像挿入"><Icon name="image" size={16}/></button>
            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
            <span className="text-[10px] text-gray-400 ml-2 hidden sm:inline">※画像ダブルクリックでAlt編集</span>
        </div>
        
        <div 
            ref={editorRef} 
            contentEditable 
            className="editor-content w-full p-4 min-h-[300px] outline-none markdown rounded-b-xl" 
            placeholder="ここに記事を書く..." 
            onPaste={handlePaste} 
            onDoubleClick={handleImageDblClick}
        ></div>
    </div>
</div>